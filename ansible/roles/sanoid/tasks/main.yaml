# https://github.com/jimsalterjrs/sanoid/blob/master/INSTALL.md#debianubuntu

- name: Ensure dependencies are installed
  become: true
  ansible.builtin.apt:
    name:
      - debhelper 
      - libcapture-tiny-perl 
      - libconfig-inifiles-perl 
      - pv 
      - lzop 
      - mbuffer 
      - build-essential 
      - git
      - xz-utils

- name: Create paths
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop: 
    - "{{ sanoid_tmp_path }}"
    - "{{ sanoid_tmp_path }}/source"

- name: Clone Sanoid repo
  ansible.builtin.git:
    repo: 'https://github.com/jimsalterjrs/sanoid.git'
    dest: "{{ sanoid_tmp_path }}/source"
    single_branch: true
    version: "{{ sanoid_version }}"

- name: list
  command: "ls {{ sanoid_tmp_path }}/source/packages/debian"
  register: dir_out

- name: debug
  debug: 
    var: dir_out.stdout_lines

- name: Create a symbolic link
  ansible.builtin.file:
    src: "{{ sanoid_tmp_path }}/source/packages/debian/{{ item }}"
    dest: "{{ sanoid_tmp_path }}/source/{{ item }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
    force: true
  loop: "{{ dir_out.stdout_lines }}"

- name: Build package using dpkg-buildpackage
  ansible.builtin.command:
    cmd: dpkg-buildpackage -uc -us
    chdir: "{{ sanoid_tmp_path }}/source"

- name: Install Sanoid deb file
  become: true
  ansible.builtin.apt:
    deb: "{{ sanoid_tmp_path }}/sanoid_*_all.deb"
