- ansible.builtin.debug:
    var: compose_list

- ansible.builtin.debug:
    msg: "{{ item }}/docker-compose.yaml"
  loop: "{{ compose_list }}"

- name: Create and start docker services
  community.docker.docker_compose:
    project_src: "{{ compose_config_dir }}"
    # via https://www.itix.fr/blog/ansible-add-prefix-suffix-to-list/
    files: "{{ compose_list | product(['/docker-compose.yaml']) | map('join') | list }}" 
  register: compose_output

- ansible.builtin.debug:
    var: compose_output

- name: Generate and deploy docker script
  ansible.builtin.template:
    src: templates/docker-up-all.sh.j2
    dest: "{{ compose_config_dir }}/docker-up-all.sh"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: a+x

- name: Generate and deploy docker script
  ansible.builtin.template:
    src: templates/docker-down-all.sh.j2
    dest: "{{ compose_config_dir }}/docker-down-all.sh"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: a+x

- name: Generate and deploy docker script
  ansible.builtin.template:
    src: templates/docker-restart-all.sh.j2
    dest: "{{ compose_config_dir }}/docker-restart-all.sh"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: a+x
