---
- name: Install ZFS backup tooling
  become: true
  ansible.builtin.apt:
    name: 
      - moreutils # for ts (timestamp) util
      - lzop
      - mbuffer
    state: present

# ensure SSH keys are generated for ansible_user

- name: Slurp hosts file
  ansible.builtin.slurp:
    src: $HOME/.ssh/id_ed25519.pub
  register: slurpfile

- name: Set backup server public key as fact
  ansible.builtin.set_fact:
    public_key: "{{ slurpfile['content'] | b64decode }}"

- name: slurpfile server debug slurpfile
  debug:
    var: slurpfile

- name: slurpfile server debug public_key
  debug:
    var: public_key

# - name: Allow user to deal with ZFS
#   become: true
#   ansible.builtin.command: "zfs allow -u {{ansible_user}} send,hold {{ item }}"
#   loop: "{{ backup_datasets }}"
#   when: backup_datasets