---
- name: Install ZFS backup tooling
  become: true
  ansible.builtin.apt:
    name: 
      - moreutils # for ts (timestamp) util
      - lzop
      - mbuffer
    state: present

- name: Read backup server public key
  become: true
  ansible.builtin.slurp:
    src: $HOME/.ssh/id_ed25519.pub
  register: slurpfile

- name: Publish backup server public key as fact
  ansible.builtin.set_fact:
    public_key: "{{ slurpfile['content'] | b64decode }}"

- name: Create backuppool dataset
  become: true
  community.general.zfs:
    name: backuppool
    state: present
    extra_zfs_properties:
      acltype: posix
      xattr: sa
      # mountpoint: none

- name: "Ensure /backuppool mountpoint is owned by {{ansible_user}}"
  become: true
  ansible.builtin.file:
    path: /backuppool
    owner: "{{ansible_user}}"
    group: "{{ansible_user}}"
    state: directory
    mode: 0774
    recurse: yes

- name: Pull backups of listed datasets
  become: true
  ansible.builtin.cron:
    name: "Syncoid - {{item}}"
    month: "*" 
    day: "*" 
    hour: "7"
    minute: "*"
    weekday: "*"
    job: "TZ=UTC sudo syncoid --sendoptions=Rw  --no-privilege-elevation --no-sync-snap zfsbackup@192.168.1.116:{{item}} backuppool/{{item}} && /usr/bin/curl -s --form-string token=\"{{vault_pushover_home_automation_key}}\" --form-string user=\"{{vault_pushover_user_key}}\" --form-string message=\"{{inventory_hostname}} backup of {{item}} finished - $(date --iso-8601=seconds)\" https://api.pushover.net/1/messages.json"
    state: present
  loop: "{{ backup_datasets }}" ?????????
  when: backup_datasets ?????????


