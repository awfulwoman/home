# Deactivate role
- name: Deactivate Cron
  become: true
  ansible.builtin.cron:
    name: "Auto-suspend"
    state: absent
  when: sleepuntil_active is false

- name: Remove script
  become: true
  ansible.builtin.file:
    dest: "{{ sleepuntil_install_location }}/sleepuntil.sh"
    state: absent
  when: sleepuntil_active is false



# Activate role
- name: "Copy sleepuntil script"
  become: true
  ansible.builtin.template:
    src: sleepuntil.sh.conf
    dest: "{{ sleepuntil_install_location }}/sleepuntil.sh"
    mode: 0755
  when: sleepuntil_active

- name: Cron to auto-suspend in early hours
  become: true
  ansible.builtin.cron:
    name: "Auto-suspend"
    hour: "{{ sleepuntil_autosleep_time_hour }}"
    minute: "{{ sleepuntil_autosleep_time_minute }}"
    job: "/usr/local/bin/sleepuntil.sh {{ sleepuntil_sleep_time }}"
    state: present
  when: sleepuntil_autosleep and sleepuntil_active

- name: Check to see if sleep until official wake-up time should occur
  become: true
  ansible.builtin.command: "/usr/local/bin/sleepuntil.sh {{ sleepuntil_sleep_time }}"
  async: 10
  poll: 0
  when: sleepuntil_sleep_immediately and sleepuntil_active

- name: Allow the root user to sudo /usr/sbin/rtcwake with no password
  become: true
  community.general.sudoers:
    name: allow-rtcwake
    state: present
    user: root
    nopassword: true
    commands: /usr/sbin/rtcwake

- name: Allow the root user to sudo /usr/bin/killall with no password
  become: true
  community.general.sudoers:
    name: allow-killall
    state: present
    user: root
    nopassword: true
    commands: /usr/bin/killall


# TODO: Listen for sleepuntil MQTT message
