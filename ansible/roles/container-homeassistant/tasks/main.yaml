- name: "Set config path: {{ container_name }}"
  ansible.builtin.set_fact:
    container_config_dir: "{{ ansible_env.HOME }}"
  when: container_config_dir is undefined

- name: "Create config dir: {{ container_name }}"
  become: true
  ansible.builtin.file:
    path: "{{ container_config_dir }}/{{ container_name }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0774
    recurse: true

- name: Check to see if docker-venv is installed
  ansible.builtin.stat:
    path: "{{ container_config_dir }}/{{ container_name }}/docker/run"
  register: docker_venv

- name: Git checkout homeassistant-docker-venv repo
  ansible.builtin.git:
    repo: "https://github.com/tribut/homeassistant-docker-venv"
    dest: "{{ container_config_dir }}/{{ container_name }}/docker"
    version: master
    force: true
  when: not docker_venv.stat.exists

- name: "Pull image: {{ container_name }}"
  community.docker.docker_image:
    name: "{{ container_name }}"
    repository: "{{ container_image }}"
    tag: latest
    source: pull
    state: present

- name: "Ensure container exists: {{ container_name }}"
  community.docker.docker_container:
    name: "{{ container_name }}"
    image: "{{ container_name }}:latest"
    state: started
    privileged: true
    restart_policy: unless-stopped
    network_mode: host
    capabilities:
      - NET_RAW
      - NET_ADMIN
    env:
      TZ: "Berlin/Europe"
      PUID: "1000"
      PGID: "1000"
      UMASK: "007"
      PACKAGES: "iputils"
    volumes:
      - "{{ container_config_dir }}/{{ container_name }}:/config"
      - /etc/localtime:/etc/localtime:ro
      # - /run/dbus:/run/dbus:ro
      - "{{ container_config_dir }}/{{ container_name }}/docker/run:/etc/services.d/home-assistant/run"
