---
- name: Provision the Proxmox host 
  hosts: host-ladyrona
  # hosts: proxmox
  vars:
    dhcpip_ifname: enp3s0
    terraform_role: TerraformProv
    terraform_user: terraform-prov@pve
    terraform_role_command: 'pveum role add {{terraform_role}} -privs "VM.Allocate VM.Clone VM.Config.CDROM VM.Config.CPU VM.Config.Cloudinit VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Monitor VM.Audit VM.PowerMgmt Datastore.AllocateSpace Datastore.Audit"'
    terraform_user_command: "pveum user add {{terraform_user}} --password {{vault_terraform_prov_password}}"
    terraform_acl_command: "pveum aclmod / -user {{terraform_user}} -role {{terraform_role}}"
  pre_tasks:
    - name: Get Proxmox roles
      ansible.builtin.command: pveum role list
      register: proxmox_roles
      changed_when: false
    - name: Get Proxmox users
      ansible.builtin.command: pveum user list
      register: proxmox_users
      changed_when: false
    - name: Get Proxmox ACLs
      ansible.builtin.command: pveum acl list
      register: terraform_acls
      changed_when: false
  tasks:
    - name: Add Terraform provisioning role
      ansible.builtin.command: "{{terraform_role_command}}"
      when: terraform_role not in proxmox_roles.stdout
      register: terraform_role_command_output
    - name: Add TerraformProv user
      ansible.builtin.command: "{{terraform_user_command}}"
      when: terraform_user not in proxmox_users.stdout
      register: terraform_user_command_output
    - name: Add TerraformProv user to role
      ansible.builtin.command: "{{terraform_acl_command}}"
      when: (terraform_user or terraform_role) not in terraform_acls.stdout
      register: terraform_acl_command_output

    #Â update grub
    # /etc/default/grub
    # ------------
    # GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on"

    # add modules
    # /etc/modules
    # ------------
    # vfio
    # vfio_iommu_type1
    # vfio_pci
    # vfio_virqfd

  handlers:
    - name: Reboot host
      become: true
      reboot:

        
