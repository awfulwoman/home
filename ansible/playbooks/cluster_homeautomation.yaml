---
# Playbook - K8s Cluster
# ---------------------------------
# This will take the machines in the k8s group, install various OS updates, 
# install k3s on each, and intialise a k8s cluster if one doesn't otherwise exist. If one 
# exists then updates to the OS will be applied and the k8s state checked.

- name: k8s Cluster - Apply standard OS config
  hosts: k8s
  roles:
    - role: standard_os
    - role: weareinteractive.environment
      no_log: true
    - role: upgrade
  handlers:
    - name: Reboot host
      reboot:

- name: k8s Cluster - Apply Raspberry Pi hardware config
  hosts: k8s_raspberrypis
  handlers:
    - name: Reboot system
      reboot:
  roles:
    - raspberry_pi

- name: k8s Cluster - Activate Kubernetes
  hosts: k8s
  vars:
    k3s_become_for_all: yes
  roles:
    - role: kubernetes_support
    - role: xanmanning.k3s
      k3s_state: installed
