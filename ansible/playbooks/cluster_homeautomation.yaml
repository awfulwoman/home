---
# Playbook - Home Auomation Cluster
# ---------------------------------
# This will take the machines in the homeautomation group, install various OS updates, 
# install k3s on each, and intialise a k8s cluster if one doesn't otherwise exist. If one 
# exists then updates to the OS will be applied and the k8s state checked.

- name: Home Automation Cluster - Apply standard OS config
  hosts: homeautomation
  roles:
    - role: standard_os
    - role: weareinteractive.environment
      no_log: true
    - role: upgrade
  handlers:
    - name: Reboot host
      reboot:
  become: true

- name: Home Automation Cluster - Apply Raspberry Pi hardware config
  hosts: homeautomation_raspberrypis
  handlers:
    - name: Reboot system
      reboot:
  roles:
    - raspberry_pi
  become: true

- name: Home Automation Cluster - Activate Kubernetes
  hosts: homeautomation
  vars:
    k3s_become_for_all: yes
  roles:
    - role: kubernetes_support
    - role: xanmanning.k3s
      k3s_state: installed
